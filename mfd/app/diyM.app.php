<?php/** * Cotte licence * * @copyright  Copyright (c) 2007-2016 cotte.cn Inc. (http://www.cotte.cn) * @license  http://license.cotte.cn/ cotte License */define('MAX_LAYER', 6);/** |-------------------------------------------------------------------------- | 定制商品分类管理 |-------------------------------------------------------------------------- | | | @author 小五 <xiao5.china@gmail.com> | */class DiyMApp extends BackendApp{	var $_fdiy_management_mod;	// private $_mod_fdict;			function __construct()	{		$this->fdiy_managementApp();	}		function fdiy_managementApp()	{		parent::BackendApp();			$this->_fdiy_management_mod =& m('fdiy_management');		// $this->_mod_fdict = &m("fdiy_dict");		$this->show_items=array(		    '0'=>'否',		    '1'=>'是'		);	}		/* 管理 */	function index()	{		/* 取得工艺分类 */		$acategories = $this->_fdiy_management_mod->get_list();		$tree =& $this->_tree($acategories);		/* 先根排序 */		$sorted_acategories = array();		$cate_ids = $tree->getChilds();		$fbcategory_mod =& m('fbcategory');		$fbcategories = $fbcategory_mod->get_list();		foreach ((array)$acategories as $key=>$row) {		    if ($row['did']) {		        $cname = array();		        foreach (explode(',',$row['did']) as $id) {		            $cname[]=$fbcategories[$id]['cate_name'];		        }		        $acategories[$key]['cname'] = implode(' | ',$cname);		    }		}		foreach ($cate_ids as $id)		{			$parent_children_valid = $this->_fdiy_management_mod->parent_children_valid($id);			$sorted_acategories[] = array_merge($acategories[$id], array('layer' => $tree->getLayer($id), 'parent_children_valid'=>$parent_children_valid));		}				$this->assign('acategories', $sorted_acategories);			/* 构造映射表（每个结点的父结点对应的行，从1开始） */		$row = array(0 => 0);   // cate_id对应的row		$map = array();         // parent_id对应的row		foreach ($sorted_acategories as $key => $fdiy_management)		{			$row[$fdiy_management['cate_id']] = $key + 1;			$map[] = $row[$fdiy_management['parent_id']];		}		$this->assign('map', ecm_json_encode($map));			$this->assign('max_layer', MAX_LAYER);			$this->import_resource(array(				'script' => 'jqtreetable.js,inline_edit_admin.js',				'style'  => 'res:style/jqtreetable.css')		);		$this->display('fdiy.management.index.html');	}		/* 新增 */	function add()	{		if (!IS_POST)		{			/* 参数 */			$pid = empty($_GET['pid']) ? 0 : intval($_GET['pid']);			$fdiy_management = array('parent_id' => $pid, 'sort_order' => 255);			$this->assign('fdiy_management', $fdiy_management);				/* 如果当前分类是不能有上下级的分类，则不可添加下级分类 */			if(!$this->_fdiy_management_mod->parent_children_valid($pid))			{				$this->show_warning('cannot_add_children');				return;			}			$this->import_resource(array(					'script' => 'jquery.plugins/jquery.validate.js'			));			$acategories = $this->_fdiy_management_mod->get_list();			$tree =& $this->_tree($acategories);			$this->assign('parents', $this->_get_options());			$this->assign('layer', $tree->getLayer($pid));			$this->assign('data', ['category'=>1]);// 			$this->assign("cat_list",   $this->_mod_fdict->init);			$this->assign('show_items',$this->show_items);			$this->display('fdiy.management.form.html');		}		else		{			$data = array(					'cate_name'  => $_POST['cate_name'],					'parent_id'  => $_POST['parent_id'],					'sort_order' => $_POST['sort_order'],					'did' => isset($_POST['item']) ? implode(',',$_POST['item']) : 0,    			    'if_show'    => isset($_POST['if_show'])?$_POST['if_show']:'1',    			    'small_img'     => isset($_POST['small_img'])?addslashes($_POST['small_img']):'',			);			/* 检查名称是否已存在 */			if (!$this->_fdiy_management_mod->unique(trim($data['cate_name']), $data['parent_id']))			{				$this->show_warning('name_exist');				return;			}				/* 选择的上级分类不允许有下级分类 */			if(!$this->_fdiy_management_mod->parent_children_valid($data['parent_id']))			{				$this->show_warning('cannot_be_parent');				return;			}				/* 保存 */			$cate_id = $this->_fdiy_management_mod->add($data);			if (!$cate_id)			{				$this->show_warning($this->_fdiy_management_mod->get_error());				return;			}				$this->show_message('add_ok',					'back_list',    'index.php?app=diyM',					'continue_add', 'index.php?app=diyM&amp;act=add&amp;pid=' . $data['parent_id']			);		}	}		/* 检查工艺分类的唯一性 */	function check_fdiy_management()	{		$cate_name = empty($_GET['cate_name']) ? '' : trim($_GET['cate_name']);		$parent_id = empty($_GET['parent_id']) ? 0 : intval($_GET['parent_id']);		$cate_id   = empty($_GET['id']) ? 0 : intval($_GET['id']);		if (!$cate_name)		{			echo ecm_json_encode(true);			return ;		}		if ($this->_fdiy_management_mod->unique($cate_name, $parent_id, $cate_id))		{			echo ecm_json_encode(true);		}		else		{			echo ecm_json_encode(false);		}		return ;	}		/* 编辑 */	function edit()	{		$id = empty($_GET['id']) ? 0 : intval($_GET['id']);		if (!IS_POST)		{			/* 是否存在 */			$fdiy_management = $this->_fdiy_management_mod->get_info($id);			if (!$fdiy_management)			{				$this->show_warning('fdiy_management_empty');				return;			}			/* 如果当前分类是系统分类，则不可编辑 */			if($fdiy_management['code'])			{				$this->show_warning('cannot_edit_system_fdiy_management');				return;			}			/*是工艺*/			if($fdiy_management['did']){			  $this->_fbcategory_mod =& m('fbcategory');			  $items = $this->_fbcategory_mod->find(array(			                "conditions" => "cate_id ".db_create_in($fdiy_management['did']),			                'fields'     => "cate_id as id, cate_name as name"			          ));			  $this->assign("items",   $items);			    			}			$this->assign('data', ['category'=>1]);			$this->assign('show_items',$this->show_items);			// $this->assign("cat_list",   $this->_mod_fdict->init);			$this->assign('fdiy_management', $fdiy_management);			if ($this->_fdiy_management_mod->parent_children_valid($id))			{				$this->assign('parents', $this->_get_options($id));			}			$this->import_resource(array(					'script' => 'jquery.plugins/jquery.validate.js'			));			$this->display('fdiy.management.form.html');		}		else		{			$data = array(					'cate_name'  => $_POST['cate_name'],					'parent_id'  => $_POST['parent_id'],					'sort_order' => $_POST['sort_order'],    			    'did' => isset($_POST['item']) ? implode(',',$_POST['item']) : 0,    			    'if_show'    => isset($_POST['if_show'])?$_POST['if_show']:'1',    			    'small_img'     => isset($_POST['small_img'])?addslashes($_POST['small_img']):'',			);			/* 选择的上级分类不允许有下级分类 */			if(!$this->_fdiy_management_mod->parent_children_valid($data['parent_id']))			{				$this->show_warning('cannot_be_parent');				return;			}			/* 检查名称是否已存在 */			if (!$this->_fdiy_management_mod->unique(trim($data['cate_name']), $data['parent_id'], $id))			{				$this->show_warning('name_exist');				return;			}				/* 保存 */			$rows = $this->_fdiy_management_mod->edit($id, $data);			if ($this->_fdiy_management_mod->has_error())			{				$this->show_warning($this->_fdiy_management_mod->get_error());				return;			}				$this->show_message('edit_ok',					'back_list',    'index.php?app=diyM',					'edit_again',   'index.php?app=diyM&amp;act=edit&amp;id=' . $id			);		}	}		//异步修改数据	function ajax_col()	{		$id     = empty($_GET['id']) ? 0 : intval($_GET['id']);		$column = empty($_GET['column']) ? '' : trim($_GET['column']);		$value  = isset($_GET['value']) ? trim($_GET['value']) : '';		$data   = array();			if (in_array($column ,array('cate_name', 'sort_order')))		{			$data[$column] = $value;			if($column == 'cate_name')			{				$fdiy_management = $this->_fdiy_management_mod->get_info($id);					if(!$this->_fdiy_management_mod->unique($value, $fdiy_management['parent_id'], $id))				{					echo ecm_json_encode(false);					return ;				}			}			$this->_fdiy_management_mod->edit($id, $data);			if(!$this->_fdiy_management_mod->has_error())			{				echo ecm_json_encode(true);			}		}		else		{			return ;		}		return ;	}		/* 删除 */	function drop()	{		$id = isset($_GET['id']) ? trim($_GET['id']) : '';		if (!$id)		{			$this->show_warning('no_fdiy_management_to_drop');			return;		}			$ids = explode(',', $id);		$message = 'drop_ok';		foreach ($ids as $key=>$id){			$fdiy_management=$this->_fdiy_management_mod->find(intval($id));			$fdiy_management=current($fdiy_management);			if($fdiy_management['code']!=null)			{				unset($ids[$key]);  //有部分是系统分类 过滤掉				$message = 'drop_ok_system_fdiy_management';			}		}		if (!$ids)		{			$message = 'system_fdiy_management'; //全是系统分类			$this->show_warning($message);				return;		}			if (!$this->_fdiy_management_mod->drop($ids))		{			$this->show_warning($this->_fdiy_management_mod->get_error());			return;		}			$this->show_message($message);	}		/* 更新排序 */	function update_order()	{		if (empty($_GET['id']))		{			$this->show_warning('Hacking Attempt');			return;		}			$ids = explode(',', $_GET['id']);		$sort_orders = explode(',', $_GET['sort_order']);		foreach ($ids as $key => $id)		{			$this->_fdiy_management_mod->edit($id, array('sort_order' => $sort_orders[$key]));		}			$this->show_message('update_order_ok');	}		/* 构造并返回树 */	function &_tree($acategories)	{		import('tree.lib');		$tree = new Tree();		$tree->setTree($acategories, 'cate_id', 'parent_id', 'cate_name');		return $tree;	}		/* 取得可以作为上级的工艺分类数据 */	function _get_options($except = NULL)	{		$acategories = $this->_fdiy_management_mod->get_list();		/* 过滤掉不能作为上级的分类 */		foreach ($acategories as $key => $acategorie)		{			if (!$this->_fdiy_management_mod->parent_children_valid($acategorie['cate_id']))			{				unset($acategories[$key]);			}		}		$tree =& $this->_tree($acategories);		//var_dump($tree);		return $tree->getOptions(MAX_LAYER - 1, 0, $except);	}}