<?php/** * Cotte licence * * @copyright  Copyright (c) 2007-2016 cotte.cn Inc. (http://www.cotte.cn) * @license  http://license.cotte.cn/ cotte License *//** |-------------------------------------------------------------------------- | 属性diy |-------------------------------------------------------------------------- | | | @author liang.li | */use Cyteam\Shop\Shop;use Cyteam\Shop\Type;use Cyteam\Shop\Type\Types;    class FdiyApp extends MallbaseApp{    function __construct(){        parent::__construct();        header("Content-Type:text/html;charset=" . CHARSET);        $this->_fdiy_management_mod =& m('fdiy_management');        $this->_mod_fdict = &m("fdiy_dict");        $this->_mod_fcrossrule = &m("fdiy_crossrule");        $this->_mod_fbcategory = &m("fbcategory");        /* 读取后台树形配置 层级id只能手动定义 */        $this->_conflictCate = ['0001'=>2,'0003'=>3,'0004'=>4,'0005'=>346,'0006'=>340,'0007'=>347,'0018'=>781];        $dog_max_num = 20;        $num = [];        for ($x=1; $x<=$dog_max_num; $x++)        {            $num[] = $x;        }//echo '<pre>';print_r($num);exit;        $this->assign('dog_num_arr',$num);    }        /**     * http://local.mfd.com/fdiy-1-3.html     * 属性diy入口     * @param 1            品类     */    function index()    {        $lists=array();//所有犬种        $list=array();//所有犬种的父分类        $common_lists=array();//常用犬种        $group_lists=array();//分组犬种        $letters=array();//字母检索数组        $user = $this->visitor->get();        $this->assign('mid', empty($user) ? 0 : $user['user_id']);        $args = $this->get_params();        $cid = empty($args[0]) ? '1' : $args[0]; //配置一级id                 $s = isset($_GET['s']) ? $_GET['s'] : "";//搜索        $do = isset($_GET['do']) ? $_GET['do'] : "";//搜索        /* 取得diy配置 */        $acategories = $this->_fdiy_management_mod->get_list($cid);                 if (empty($acategories)){            $this->show_warning('该品类下还没有关联的定制属性，请返回~');            return;        }                 $sid = empty($args[1]) ? current($acategories)['cate_id'] : $args[1]; //配置二级id        $dids= array_unique(explode(',', $acategories[$sid]['did']));                 if (empty($dids)){            $this->show_warning('该品类下还没有录入定制属性，请返回~');            return;        }        $conditions = " parent_id = 21";        $list = $this->_mod_fbcategory->find(array(            'conditions' => $conditions,        ));        if($list){            $quan_ids = i_array_column($list, "cate_id");                    $qconditions = db_create_in($quan_ids,"parent_id");            if ($s)             {               $qconditions .= " AND cate_name like '%$s%' " ;            }                        $lists = $this->_mod_fbcategory->find(array(                'conditions' => $qconditions." AND if_show =1",                "order"      => "letter_retrieval ASC,sort_order ASC",            ));            if($lists){                foreach ($lists as $key => $value) {                    if($value['if_common']){                        $common_lists[]=$value;                    }                    $group_lists[$value['letter_retrieval']][$key]=$value;                }                if(isset($group_lists[''])){                    array_push($group_lists,$group_lists['']);                    unset($group_lists['']);                }                $letters=array_keys($group_lists);            }                    }        //获取微信配置        require_once "weipay/jssdk.php";        $jssdk = new JSSDK();        $signPackage = $jssdk->getSignPackage();        $configs=array(            'appId'=> $signPackage["appId"],            'timestamp'=>$signPackage["timestamp"],            'nonceStr'=> $signPackage["nonceStr"],            'signature'=>$signPackage["signature"],        );        $this->assign('config',$configs);        $this->assign('do',$do);        $this->assign('common_list',$common_lists);        $this->assign("list",$group_lists);        $this->assign("title","选择您的爱宠");        $this->assign('letters',$letters);        $this->display('fdiy/index_new.html');    }    /**     * http://local.mfd.com/fdiy-1-3.html     * 属性diy入口     * @param 1            品类     */    function tryeat()    {        $lists=array();//所有犬种        $list=array();//所有犬种的父分类        $common_lists=array();//常用犬种        $group_lists=array();//分组犬种        $letters=array();//字母检索数组        $user = $this->visitor->get();        $this->assign('mid', empty($user) ? 0 : $user['user_id']);        $args = $this->get_params();        $cid = empty($args[0]) ? '1' : $args[0]; //配置一级id        $s = isset($_GET['s']) ? $_GET['s'] : "";//搜索        $do = isset($_GET['do']) ? $_GET['do'] : "";//搜索        $order_mod = m('order');        $day_time = strtotime(date("Y-m-d"));        $order_num = $order_mod->get(array(            'conditions' => " is_try=1 AND add_time >= $day_time AND status IN(20,30,40)",            'fields' => "count(*) as num",        ));        if($order_num['num'] >= 501)        {            $this->show_warning('亲，今日500单的“付邮0元定制体验”活动名额已满，请您明日记得早点参加体验活动哦！');            return;        }        /* 取得diy配置 */        $acategories = $this->_fdiy_management_mod->get_list($cid);        if (empty($acategories)){            $this->show_warning('该品类下还没有关联的定制属性，请返回~');            return;        }        $sid = empty($args[1]) ? current($acategories)['cate_id'] : $args[1]; //配置二级id        $dids= array_unique(explode(',', $acategories[$sid]['did']));        if (empty($dids)){            $this->show_warning('该品类下还没有录入定制属性，请返回~');            return;        }        $conditions = " parent_id = 21";        $list = $this->_mod_fbcategory->find(array(            'conditions' => $conditions,        ));        if($list){            $quan_ids = i_array_column($list, "cate_id");            $qconditions = db_create_in($quan_ids,"parent_id");            if ($s)            {                $qconditions .= " AND cate_name like '%$s%' " ;            }            $lists = $this->_mod_fbcategory->find(array(                'conditions' => $qconditions." AND if_show =1",                "order"      => "letter_retrieval ASC,sort_order ASC",            ));            if($lists){                foreach ($lists as $key => $value) {                    if($value['if_common']){                        $common_lists[]=$value;                    }                    $group_lists[$value['letter_retrieval']][$key]=$value;                }                if(isset($group_lists[''])){                    array_push($group_lists,$group_lists['']);                    unset($group_lists['']);                }                $letters=array_keys($group_lists);            }        }        //获取微信配置        require_once "weipay/jssdk.php";        $jssdk = new JSSDK();        $signPackage = $jssdk->getSignPackage();        $configs=array(            'appId'=> $signPackage["appId"],            'timestamp'=>$signPackage["timestamp"],            'nonceStr'=> $signPackage["nonceStr"],            'signature'=>$signPackage["signature"],        );        $this->assign('config',$configs);        $this->assign('do',$do);        $this->assign('common_list',$common_lists);        $this->assign("list",$group_lists);        $this->assign("title","选择您的爱宠");        $this->assign('letters',$letters);        $this->display('fdiy/index_try.html');    }    function ajaxGetCateList(){        $s = isset($_GET['s']) ? $_GET['s'] : "";//搜索        if(!$s){            return $this->json_error('参数错误');        }        $conditions = "parent_id = 21";        $list = $this->_mod_fbcategory->find(array(            'conditions' => $conditions,        ));        if($list){            $quan_ids = i_array_column($list, "cate_id");                    $qconditions = db_create_in($quan_ids,"parent_id");            if ($s)             {               $qconditions .= "AND (cate_name like '%$s%' OR FIND_IN_SET('$s',sname)) " ;            }                        $lists = $this->_mod_fbcategory->find(array(                'conditions' => $qconditions." AND if_show =1",                "order"      => "letter_retrieval ASC,sort_order ASC",            ));            if($lists){                return $this->json_result($lists,'成功');            }else{                return $this->json_error('失败');            }                    }    }        function index3()    {               $user = $this->visitor->get();        $this->assign('mid', empty($user) ? 0 : $user['user_id']);                $args = $this->get_params();        $cid =  1; //配置一级id                 /* 取得diy配置 */        $acategories = $this->_fdiy_management_mod->get_list($cid);                 if (empty($acategories)){            $this->show_warning('！该品类下还没有关联定制属性');            return;        }        $feedmod =& m('feedamount');        $body_list = $feedmod->getBody();        $this->assign('body_list',$body_list);                 $sid = 3; //配置二级id        $dids= array_unique(explode(',', $acategories[$sid]['did']));                 if (empty($dids)){            $this->show_warning('！该品类下还没有录入定制属性');            return;        }                                 $plist = $this->_mod_fbcategory->get_descendant_ids($dids);        unset($plist[0]);                          /* 所有工艺 memcache缓存 */        $_data = $this->_mod_fbcategory->_get_data(db_create_in($plist,'cate_id')." AND if_show=1",1);        $_list =  $this->_mod_fbcategory->deep_tree($_data);	//生成嵌套格式的树形数组                //按照后台关联顺序排序        $tmp = [];        foreach ($dids as $key){            $tmp[] = $_list[$key];        }                /* 取得冲突 */        $_clist = $this->_mod_fcrossrule->find(array(            'conditions' => db_create_in($dids,'cid'),            'order' => "id DESC"        ));                $quanzhong = 21; //犬种id        $quanzhong_son = $args[0];		$this->assign('quan_id',$quanzhong_son);        $quanzhong_info = $this->_mod_fbcategory->get_info($quanzhong_son);        unset($_list[$quanzhong]);        $baozhuang_id = 16;        $guige_id = 11;        $baozhuang_list = $_list[$baozhuang_id];        $guige_list = $_list[$guige_id];        unset($_list[$baozhuang_id]);unset($_list[$guige_id]);        // 系统后台diy相关配置        $model_setting = &af('settings');         $setting = $model_setting->getAll();                $aprice = isset($setting["diy_aprice"]) ? $setting["diy_aprice"] : 1.5;     //功能料均价        $ratio = isset($setting["diy_ratio"]) ? $setting["diy_ratio"] : 25;         //单个功能料占比 /100        $maxnum = isset($setting["diy_maxnum"]) ? $setting["diy_maxnum"] : 3;       //功能料种数上限        //随机主人寄语        $word_libraries=isset($setting["word_libraries"])?$setting["word_libraries"]:'';        $word='';        if($word_libraries){            $key=array_rand($word_libraries,1);            $word=$word_libraries[$key];        }        //        {if stripos($_SERVER['HTTP_USER_AGENT'], "Huawei")!==false || stripos($_SERVER['HTTP_USER_AGENT'], "MI")!==false}                if(stripos($_SERVER['HTTP_USER_AGENT'], "Huawei")!==false || stripos($_SERVER['HTTP_USER_AGENT'], "MI")!==false){            $this->assign('is_rel','1');        }else{            $this->assign('is_rel','0');        }                $this->assign('is_weixin',is_weixin());        $this->assign('is_try',0);        $this->assign('loc',isset($_GET['loc']) ? $_GET['loc'] : 0);        $this->assign("title","个性化定制方案");        $this->assign('word',$word);//主人寄语        $this->assign('quanzhong_info',$quanzhong_info);        $this->assign('clist', $_list);        $this->assign('baozhuang_list',$baozhuang_list);        $this->assign('guige_list',$guige_list);        $this->assign('cid', $cid);        $this->assign('sid', $sid);        $this->assign('quanzhong', $quanzhong);        $this->assign('quanzhong_son', $quanzhong_son);        $this->assign('aprice', $aprice);        $this->assign('ratio', $ratio);        $this->assign('maxnum', $maxnum);        $this->assign('basedata', json_encode($tmp));        $this->assign('rule', json_encode(array_values($_clist)));        $this->display('fdiy/index4.html');           }    function index4()    {        $user = $this->visitor->get();        $this->assign('mid', empty($user) ? 0 : $user['user_id']);        $args = $this->get_params();        $cid =  1; //配置一级id        /* 取得diy配置 */        $acategories = $this->_fdiy_management_mod->get_list($cid);        if (empty($acategories)){            $this->show_warning('！该品类下还没有关联定制属性');            return;        }        $feedmod =& m('feedamount');        $body_list = $feedmod->getBody();        $this->assign('body_list',$body_list);        $sid = 3; //配置二级id        $dids= array_unique(explode(',', $acategories[$sid]['did']));        if (empty($dids)){            $this->show_warning('！该品类下还没有录入定制属性');            return;        }        $plist = $this->_mod_fbcategory->get_descendant_ids($dids);        unset($plist[0]);        /* 所有工艺 memcache缓存 */        $_data = $this->_mod_fbcategory->_get_data(db_create_in($plist,'cate_id')." AND if_show=1 AND is_try=1 ",1);//        echo '<pre>';print_r($_data);exit;                $_list =  $this->_mod_fbcategory->deep_tree($_data);	//生成嵌套格式的树形数组        //按照后台关联顺序排序        $tmp = [];        foreach ($dids as $key){            $tmp[] = $_list[$key];        }        /* 取得冲突 */        $_clist = $this->_mod_fcrossrule->find(array(            'conditions' => db_create_in($dids,'cid'),            'order' => "id DESC"        ));        $quanzhong = 21; //犬种id        $quanzhong_son = $args[0];		$this->assign('quan_id',$quanzhong_son);        $quanzhong_info = $this->_mod_fbcategory->get_info($quanzhong_son);        unset($_list[$quanzhong]);        $baozhuang_id = 16;        $guige_id = 11;        $baozhuang_list = $_list[$baozhuang_id];        $guige_list = $_list[$guige_id];        unset($_list[$baozhuang_id]);unset($_list[$guige_id]);        // 系统后台diy相关配置        $model_setting = &af('settings');        $setting = $model_setting->getAll();        $aprice = isset($setting["diy_aprice"]) ? $setting["diy_aprice"] : 1.5;     //功能料均价        $ratio = isset($setting["diy_ratio"]) ? $setting["diy_ratio"] : 25;         //单个功能料占比 /100        $maxnum =  2;       //功能料种数上限        //随机主人寄语        $word_libraries=isset($setting["word_libraries"])?$setting["word_libraries"]:'';        $word='';        if($word_libraries){            $key=array_rand($word_libraries,1);            $word=$word_libraries[$key];        }//        {if stripos($_SERVER['HTTP_USER_AGENT'], "Huawei")!==false || stripos($_SERVER['HTTP_USER_AGENT'], "MI")!==false}        if(stripos($_SERVER['HTTP_USER_AGENT'], "Huawei")!==false || stripos($_SERVER['HTTP_USER_AGENT'], "MI")!==false){            $this->assign('is_rel','1');        }else{            $this->assign('is_rel','0');        }        if(isset($guige_list['children']['115']))        {            $guige_list['children']['115']['is_def'] = 1;        }        if(isset($baozhuang_list['children']['20']))        {            $baozhuang_list['children']['20']['is_def'] = 1;        }        $this->assign('is_weixin',is_weixin());        $this->assign('is_try',1);        $this->assign('loc',isset($_GET['loc']) ? $_GET['loc'] : 0);        $this->assign("title","个性化定制方案");        $this->assign('word',$word);//主人寄语        $this->assign('quanzhong_info',$quanzhong_info);        $this->assign('clist', $_list);        $this->assign('baozhuang_list',$baozhuang_list);        $this->assign('guige_list',$guige_list);        $this->assign('cid', $cid);        $this->assign('sid', $sid);        $this->assign('quanzhong', $quanzhong);        $this->assign('quanzhong_son', $quanzhong_son);        $this->assign('aprice', $aprice);        $this->assign('ratio', $ratio);        $this->assign('maxnum', $maxnum);        $this->assign('basedata', json_encode($tmp));        $this->assign('rule', json_encode(array_values($_clist)));        $this->display('fdiy/index5.html');    }    function ajaxFdiy()    {        $args = $this->get_params();        $quanzhong_son = 41;        $cid =  1; //配置一级id        /* 取得diy配置 */        $acategories = $this->_fdiy_management_mod->get_list($cid);        if (empty($acategories))        {            $this->show_warning('！该品类下还没有关联定制属性');            return;        }        $sid = 3; //配置二级id        $dids= array_unique(explode(',', $acategories[$sid]['did']));        if (empty($dids)){            $this->show_warning('！该品类下还没有录入定制属性');            return;        }        $plist = $this->_mod_fbcategory->get_descendant_ids($dids);        unset($plist[0]);        /* 所有工艺 memcache缓存 */        $_data = $this->_mod_fbcategory->_get_data(db_create_in($plist,'cate_id')." AND if_show=1",1);        $_list =  $this->_mod_fbcategory->deep_tree($_data);	//生成嵌套格式的树形数组        //按照后台关联顺序排序        $tmp = [];        foreach ($dids as $key){            $tmp[] = $_list[$key];        }        /* 取得冲突 */        $_clist = $this->_mod_fcrossrule->find(array(            'conditions' => db_create_in($dids,'cid'),            'order' => "id DESC"        ));        $quanzhong = 21; //犬种id//        $this->assign('quan_id',$quanzhong_son);        $quanzhong_info = $this->_mod_fbcategory->get_info($quanzhong_son);        unset($_list[$quanzhong]);//        $baozhuang_id = 16;//        $guige_id = 11;//        $baozhuang_list = $_list[$baozhuang_id];//        $guige_list = $_list[$guige_id];//        unset($_list[$baozhuang_id]);unset($_list[$guige_id]);        // 系统后台diy相关配置        $model_setting = &af('settings');        $setting = $model_setting->getAll();        $aprice = isset($setting["diy_aprice"]) ? $setting["diy_aprice"] : 1.5;     //功能料均价        $ratio = isset($setting["diy_ratio"]) ? $setting["diy_ratio"] : 25;         //单个功能料占比 /100        $maxnum = isset($setting["diy_maxnum"]) ? $setting["diy_maxnum"] : 3;       //功能料种数上限        //随机主人寄语        $word_libraries=isset($setting["word_libraries"])?$setting["word_libraries"]:'';        $word='';        if($word_libraries){            $key=array_rand($word_libraries,1);            $word=$word_libraries[$key];        }        $return = [];        $return['is_try'] = 0;        $return['word'] = $word;        $return['quanzhong_info'] = $quanzhong_info;//        $return['clist'] = $_list;//        $return['baozhuang_list'] = $baozhuang_list;//        $return['guige_list'] = $guige_list;        $return['aprice'] = $aprice;        $return['ratio'] = $ratio;        $return['maxnum'] = $maxnum;        $return['rule'] = $_clist;        $fclist['shengzhang'] = $_list[34];        $fclist['gongxiao'] = $_list[1];        $fclist['kouwei'] = $_list[6];        $fclist['guige'] = $_list[11];        $fclist['baozhuang'] = $_list[16];        $return['fclist'] = $fclist;        $this->json_result($return);        return;        $this->assign('is_weixin',is_weixin());        $this->assign('is_try',0);        $this->assign('loc',isset($_GET['loc']) ? $_GET['loc'] : 0);        $this->assign("title","个性化定制方案");        $this->assign('word',$word);//主人寄语        $this->assign('quanzhong_info',$quanzhong_info);        $this->assign('clist', $_list);        $this->assign('baozhuang_list',$baozhuang_list);        $this->assign('guige_list',$guige_list);        $this->assign('cid', $cid);        $this->assign('sid', $sid);        $this->assign('quanzhong', $quanzhong);        $this->assign('quanzhong_son', $quanzhong_son);        $this->assign('aprice', $aprice);        $this->assign('ratio', $ratio);        $this->assign('maxnum', $maxnum);        $this->assign('basedata', json_encode($tmp));        $this->assign('rule', json_encode(array_values($_clist)));        $this->display('fdiy/index4.html');    }    public function rangjs()    {//        $this->_init_view();        $this->assign('aa',33);        $this->display("fdiy/rang.html");        return 11;        $res = $this->_view->fetch("fdiy/rang.html");        echo  $res;//        $this->display("fdiy/rang.html");    }    public function rangjsss()    {//        $this->_init_view();        $this->assign('aa',33);//        $res = $this->_view->fetch("fdiy/rang.html");        $this->display("fdiy/rang.html");    }    public function debit()    {        $url = SITE_URL."member-quan-1.html";        header("Location:$url");    }    /**     * 饲喂量建议     */    function formFeed()    {        $goods = Types::createObj("fdiy");        $price_arr = $goods->fmoatFeed($_POST);        if (!$price_arr)        {            $this->json_error("饲喂量配置无法获取");            return;        }        $this->json_result($price_arr);    }     /**     * http://local.mfd.com/fdiy-1-3.html     * 属性diy入口     * @param 1            品类     */    function index2()    {		$user = $this->visitor->get();		$this->assign('mid', empty($user) ? 0 : $user['user_id']);    	$args = $this->get_params();    	$cid = empty($args[0]) ? '1' : $args[0]; //配置一级id    	    	    	/* 取得diy配置 */    	$acategories = $this->_fdiy_management_mod->get_list($cid);    	    	if (empty($acategories)){    	    $this->show_warning('！该品类下还没有关联定制属性');    		return;    	}    	    	$sid = empty($args[1]) ? current($acategories)['cate_id'] : $args[1]; //配置二级id    	$dids= array_unique(explode(',', $acategories[$sid]['did']));    	    	if (empty($dids)){    	    $this->show_warning('！该品类下还没有录入定制属性');    	    return;    	}    	    	$plist = $this->_mod_fbcategory->get_descendant_ids($dids);    	unset($plist[0]);    	    	    	/* 所有工艺 memcache缓存 */    	$_data = $this->_mod_fbcategory->_get_data(db_create_in($plist,'cate_id'),1);    	$_list =  $this->_mod_fbcategory->deep_tree($_data);	//生成嵌套格式的树形数组    	//按照后台关联顺序排序        $tmp = [];        foreach ($dids as $key){            $tmp[] = $_list[$key];        }		/* 取得冲突 */		$_clist = $this->_mod_fcrossrule->find(array(				'conditions' => db_create_in($dids,'cid'),				'order' => "id DESC"		));                                        // 系统后台diy相关配置        $model_setting = &af('settings');        $setting = $model_setting->getAll();                 $aprice = isset($setting["diy_aprice"]) ? $setting["diy_aprice"] : 1.5;     //功能料均价        $ratio = isset($setting["diy_ratio"]) ? $setting["diy_ratio"] : 25;         //单个功能料占比 /100         $maxnum = isset($setting["diy_maxnum"]) ? $setting["diy_maxnum"] : 3;       //功能料种数上限 // print_exit($maxnum);    	$this->assign('cid', $cid);    	$this->assign('sid', $sid);    	$this->assign('aprice', $aprice);    	$this->assign('ratio', $ratio);    	$this->assign('maxnum', $maxnum);    	$this->assign('basedata', json_encode($tmp));    	$this->assign('rule', json_encode(array_values($_clist)));         $this->display('fdiy/fdiy.dict.html');    }	function __destruct()	{		// TODO: Implement __destruct() method.	}		function formPrice() 	{	    	    $cate_id = isset($_REQUEST['cate_id']) ? intval($_REQUEST['cate_id']) : 0;	    $age_id = isset($_REQUEST['age_id']) ? intval($_REQUEST['age_id']) : 0;	    $baozhuang = isset($_REQUEST['baozhuang']) ? intval($_REQUEST['baozhuang']) : 0;	    $guige = isset($_REQUEST['guige']) ? intval($_REQUEST['guige']) : 0;	    $gongxiao = isset($_REQUEST['gongxiao']) ? $_REQUEST['gongxiao'] : '';        $is_try = isset($_REQUEST['is_try']) ? intval($_REQUEST['is_try']) : 0;	    $goods = Types::createObj("fdiy");	    $price_arr = $goods->fmoatPrice($cate_id,$age_id,$baozhuang,$guige,$gongxiao,1,$is_try);        if (!$price_arr)        {            $this->json_error("此组合无法匹配价格,请联系客服");            return;        }	    	    $this->json_result($price_arr);	    	}	/**     * 获取面料信息        品类｜面料code     * http://local.mfd.com/fdiy-agf-0003-DSA605A.html     */    function agf()    {    	$res = ['err'=>1,'msg'=>'请选择品类!'];    	$args = $this->get_params();    	$cid = empty($args[0]) ? '0003' : $args[0];    	$fcode = empty($args[1]) ? 'DSA605A' : $args[1];    	if (!$cid || !$fcode){    		echo json_encode($res);    		exit();    	}    	/* 获取面料详细信息 供diy数据展示 */    	$finfo = $this->_mod_fdict->_get_finfo($fcode,$cid);    	echo json_encode($finfo);    }        /**     * 获取客户指定数据信息        品类｜工艺code     * http://local.mfd.com/fdiy-agf-0003-0638.html     *     */    function agc(){    	$res = ['err'=>1,'msg'=>'请选择品类!'];    	$args = $this->get_params();    	$cid = empty($args[0]) ? '0003' : $args[0];    	$code = empty($args[1]) ? '0638' : $args[1];    	if (!$cid || !$code){    		echo json_encode($res);    		exit();    	}    	$_fdiy_comm = &m('fdiy_dcomm');    	$_clist = $_fdiy_comm->find(array(//    			'conditions' => "cid = '".$cid."' and ecode= '".$code."'",    			'conditions' => "ecode= '".$code."'",    			'order' => "id DESC"    	));    	echo json_encode(array_values($_clist));    }        /* 构造并返回树 */    function &_tree($acategories)    {    	import('tree.lib');    	$tree = new Tree();    	$tree->setTree($acategories, 'cate_id', 'parent_id', 'cate_name');    	return $tree;    }}?>